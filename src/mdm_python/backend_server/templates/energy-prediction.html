<!DOCTYPE html>
<html lang="en">
  {% extends "base.html" %}
  <head>
    {% block head %}{{ super() }}{% endblock %}
  </head>
  <body>
    {% block header %}{{ super() }}{% endblock %} {% block navbar %}{{ super()
    }}{% endblock %} {% block title %} Modell {% endblock %} {% block main %}{{
    super() }}{% endblock %} {% block content %}

    <p>Bitte wähle die Energy-Types, für die Du eine Vorhersage möchtest.</p>

    <div class="form-check">
      <p>
        <label
          ><input
            class="form-check-input"
            type="checkbox"
            name="types"
            value="wind"
          />
          Wind</label
        >
      </p>
      <p>
        <label
          ><input
            class="form-check-input"
            type="checkbox"
            name="types"
            value="solar"
          />
          Solar</label
        >
      </p>
      <p>
        <label
          ><input
            class="form-check-input"
            type="checkbox"
            name="types"
            value="nuclear"
          />
          Nuclear</label
        >
      </p>
      <p>
        <label
          ><input
            class="form-check-input"
            type="checkbox"
            name="types"
            value="water_river"
          />
          Water-River</label
        >
      </p>
      <p>
        <label
          ><input
            class="form-check-input"
            type="checkbox"
            name="types"
            value="water_pump"
          />
          Water-Pump</label
        >
      </p>
      <p>
        <label
          ><input
            class="form-check-input"
            type="checkbox"
            name="types"
            value="water_reservoir"
          />
          Water-Reservoir</label
        >
      </p>
    </div>

    <p>Bitte wähle die Anzahl Wochen für den Vorhersage-Horizont. 
      Bitte beachte, dass die Vorhersage immer ungenauer wird, je weiter Du in die Zukunft gehst. 
      Du kannst die Ungenauigkeit der Vorhersage anhand des grünen Konfindenz-Intervalls erkennen.</p>
    <label for="forecastHorizon">Vorhersage-Horizont:</label>
    <input
      type="number"
      id="forecastHorizon"
      name="forecastHorizon"
      min="1"
      value="10"
    />
    <button id="sendDataButton">Send Data</button>

    <p id="messageContainer"></p>

    <div id="plotContainer"></div>

    {% endblock %}
  </body>

  {% block scripts %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document
        .getElementById("sendDataButton")
        .addEventListener("click", sendData);
    });

    async function sendData() {
      var sendDataButton = document.getElementById("sendDataButton");
      var messageContainer = document.getElementById("messageContainer");

      // If the button is clicked and the website is waiting for a response, the button is disabled
      sendDataButton.disabled = true;
      messageContainer.innerText =
        "Bitte habe einen Moment Geduld, die Vorhersage wird berechnet.";

      var checkboxes = document.querySelectorAll('input[name="types"]:checked');
      var forecastHorizon = document.getElementById("forecastHorizon").value;
      var selectedTypes = [];
      checkboxes.forEach(function (checkbox) {
        selectedTypes.push(checkbox.value);
      });

      try {
        const response = await fetch("/energy-prediction", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            types: selectedTypes,
            forecastHorizon: forecastHorizon,
          }),
        });
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        const data = await response.json();

        messageContainer.innerText = "";
        displayPlots(data);
      } catch (error) {
        // If an error occurs, display it
        messageContainer.innerText =
          "Es ist ein Fehler aufgetreten. Bitte versuche es später erneut.";
      } finally {
        // Re-enable the button in both success and error cases
        sendDataButton.disabled = false;
      }
    }

    function displayPlots(plots) {
      console.log("Display Plots");
      const plotContainer = document.getElementById("plotContainer");
      plotContainer.innerHTML = ""; // Clear existing plots

      for (const [energyType, dataURL] of Object.entries(plots)) {
        const img = document.createElement("img");
        img.src = dataURL; // Set the source of the image
        img.alt = `Energy prediction plot for ${energyType}`;
        img.style.width = "100%"; // Optional: Set image width
        plotContainer.appendChild(img); // Add the image to the container
      }
    }
  </script>
  {% endblock %}
</html>
